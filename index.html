<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jQuery game</title>
    <style>
        .cell {
            border: 1px solid black;
            width: 16px;
            height: 16px
        }

        .party {
            background: blue;
            color: white;
            text-align: center;
        }

        .snake {
            background: yellow;
        }

        .friends {
            background: lightblue;
        }

        .aliens {
            background: black;
        }

        .head {
            background: red;
            background-image: url('https://cdn4.iconfinder.com/data/icons/penguin/154/penguin-baby-small-animal-512.png');
            background-size: 16px 16px;
        }

        .enter {
            /*background: pink;*/
        }

        .freeAlien {
            background: black;
        }

        .scoreFriends,
        .scoreAliens {
            display: block;
            font-size: 2em;
        }

    </style>
</head>
<body>

<div id="board"></div>
<div>
    <div class="scoreFriends"></div>
    <div class="scoreAliens"></div>
</div>

<h2>Zasady gry</h2>
<p></p>
<p>Dzięki Wyszukiwarce Najlepszych Imprez W Mieście udało Ci się znaleźć najlepszą imprezę tego wieczoru i nabyłeś ostatnie bilety dla siebie i swoich przyjaciół.
    Wchodzisz do imprezowej dzielnicy miasta. Twoim zadaniem jest odwiedzić wszystkie miejsca imprez, zabrać stamtąd swoich przyjaciół i udać się z nimi na Najlepszą Imprezę W Mieście.
    Jako wyjątkowo towarzyska osoba przyciągasz jednak przypadkowych imprezowiczów, którzy koniecznie chcą do Ciebie dołączyć. Każda napotkana osoba dołącza do Ciebie i Twoich przyjaciół. Przypadkowych imprezowiczów możesz zaprowadzić do dowolnego miejsca imprezy i tam pozostawić pod warunkiem, że w lokalu jest wolne miejsce. Wygrywasz, jeśli na imprezę specjalną dotrzesz tylko ze swoimi przyjaciółmi.
</p>
<table style="border: 1px solid grey; border-spacing: 5px">
    <tr>
        <td width="16px"></td>
        <td width="300px"></td>
    </tr>
    <tr>
        <td class="head"></td>
        <td>TY</td>
    </tr>
    <tr>
        <td class="friends"> </td>
        <td>Twój przyjaciel</td>
    </tr>
    <tr>
        <td class="aliens"></td>
        <td>Przypadkowy imprezowicz</td>
    </tr>
    <tr>
        <td class="party"></td>
        <td>Miejsce imprezy</td>
    </tr>
    <tr>
        <td class="party">2</td>
        <td>Liczba przyjaciół (na górze) w lokalu.</td>
    </tr>
    <tr>
        <td class="party">2</td>
        <td>Liczba wolnych miejsc (na dole) w lokalu.</td>
    </tr>
</table>

<script src="js/jquery-3.2.1.js"></script>
<script>

        var $board = $('#board');
        var $table = $('<table>');
        var $tr = $('<tr>');
        var $td;

        createTable(20, 20); // drawing board ---------
        $('td', $table).addClass('cell');
        $board.append($table);

        var aliens = 0; // snake character ---------
        var friends = 0;
        var snakeLength =  1 + friends + aliens;

        var snakeCells = $('td').slice(0, snakeLength).toArray(); //snake length
        $(snakeCells).addClass('snake');
        $(snakeCells[snakeCells.length-1]).addClass('head');

        drawSnake(); // drawing snake ---------

        $partyOne = drawParty(5, 5, 1); // drawing party places  ---------
        $partyTwo = drawParty(5, 14, 2);
        $partyThree = drawParty(14, 5, 3);
        $partyFour = drawParty(14, 14, 4);

        var partyFriends = addPartyFriends(4);
        var totalFriends = partyFriends.reduce((total, i) => total += i , 0);

        var freePlaces = addFreePlaces(4);

        $('tr td:nth-child(1)', $table).addClass('enter'); //definition area to enter new free Aliens
        $('tr td:nth-child(20)', $table).addClass('enter');
        $('tr:nth-child(1) td', $table).addClass('enter');
        $('tr:nth-child(20) td', $table).addClass('enter');
        var $enter = $('.enter');
        var freeAliens = [];
        var nextStepFreeAliens = [];

        var interval = setInterval(function () {  //generate enter free Aliens
            freeAliens.push($enter.eq(Math.floor(Math.random() * $enter.length)).addClass('freeAlien'));

            for (var i = 37; i < 41; i++) { //generate first direction of Free Alien
                if (moves[i](freeAliens[freeAliens.length-1]).length === 0) {
                    if (i < 39) {
                        nextStepFreeAliens.push(i+2);
                    } else {
                        nextStepFreeAliens.push(i-2);
                    }
                }
            }
            $enter = $('.enter').not('.freeAlien').not('.snake');
        }, 800);


        var moves = {
            38: function up($node) {
                return $node.parent().prev().find('.cell').eq($node.index());
            },
            40: function down($node) {
                return $node.parent().next().find('.cell').eq($node.index());
            },
            37: function left($node) {
                return $node.prev();
            },
            39: function right($node) {
                return $node.next();
            }
        };

        moves[38].invalid = 40;
        moves[40].invalid = 38;
        moves[37].invalid = 39;
        moves[39].invalid = 37;

        var direction = moves[40];

        $(window).on('keydown', function (event) {  // change direction

            var code = event.keyCode;

            if (code === direction.invalid) {
                return
            }

            direction = moves[event.keyCode] || direction
        });


        var interval = setInterval(function () {
            var tail = snakeCells[0];
            var head = snakeCells[snakeCells.length - 1];
            var $nextHead = direction($(head));

            if ($nextHead.hasClass('snake') || $nextHead.length === 0) {
                clearInterval(interval);
                alert('GAME OVER');
                return;
            }


            if (iCanTakeFriendFromAnyParty()) {
                for (var i = 1; i < 5; i++) {
                    if (iCanTakeFriendFromParty(i)) {
                        partyFriends[i - 1] -= 1;
                        $('.party' + i).slice(0, 1).text(partyFriends[i - 1]);
                        friends += 1;
                        $(snakeCells).removeClass('head friends aliens');
                        snakeCells = snakeCells.concat($nextHead.get(0));
                        $nextHead.addClass('head snake');
                    }
                }
            } else if (iCanLeaveAnAlienInAnyParty()) {
                 for (var j = 1; j < 5; j++) {
                     if (iCanLeaveAnAlienInParty(j)) {
                        freePlaces[j - 1] -= 1;
                        $('.party' + j).slice(8).text(freePlaces[j - 1]);
                        aliens -= 1;
                        $(snakeCells).removeClass('friends aliens');
                        $(tail).removeClass('snake');
                        snakeCells = snakeCells.slice(1);
                     }
                 }
            } else if (meetFreeAlien()) {
                aliens += 1;
                $(snakeCells).removeClass('head friends aliens');
                snakeCells = snakeCells.concat($nextHead.get(0));
                $nextHead.addClass('head snake');

            } else {
                $(snakeCells).removeClass('head friends aliens');
                $(tail).removeClass('snake');
                snakeCells = snakeCells.slice(1);
                snakeCells = snakeCells.concat($nextHead.get(0));
                $nextHead.addClass('head snake');
            }

            drawSnake();

            for (var i = 0; i < freeAliens.length-1; i++) {  //moving Free Aliens
                var nextStep = moves[nextStepFreeAliens[i]](freeAliens[i]);
                freeAliens[i].removeClass('freeAlien');
                nextStep.addClass('freeAlien');
                freeAliens[i] = nextStep;
            };

            $('.scoreFriends').text(`Poszukaj ${totalFriends-friends} przyjaciół`);
            $('.scoreAliens').text(`Masz ${aliens} obcych`);


        }, 500)


//definitions -------------------------

function createTable(width, height) {
    for (var j = 0; j < height; j++) {
        $tr = $('<tr>');
            for (var i = 0; i < width; i++) {
            $td = $('<td>');
            $tr.append($td);
        }
    $table.append($tr);
    }
}

function drawSnake() {
    for (var i = 0; i < aliens; i++) {
        $(snakeCells[i]).addClass('aliens');
    }
    for (var j = aliens; j < aliens + friends; j++) {
        $(snakeCells[j]).addClass('friends');
    }
}

function drawParty(x, y, n) {
    for (var i = x; i < x + 3; i++) {
        for (var j = y; j < y + 3; j++) {
            $('table tr:nth-child(' + i + ') td:nth-child(' + j + ')').addClass('party party' + n);
        }
    }
    return $('.party' + n);
}

function addPartyFriends(n) { // generating number of Friends in party places and info about them
    var addFriends = [];
    for (var i = 0; i < 4; i++) {
        addFriends.push(Math.round(Math.random(0,1)*3+2));
        $('.party' + (i+1)).slice(0,1).text(addFriends[i]);
    }
    return addFriends;
}

function addFreePlaces(n) { // generating number of free places in party and info about them
    var addPlaces = [];
    for (var i = 0; i < 4; i++) {
        addPlaces.push(Math.round(Math.random(0,1)*4+4));
        $('.party' + (i+1)).slice(8).text(addPlaces[i]);
    }
    return addPlaces;
}

function iCanTakeFriendFromAnyParty(){
    return iCanTakeFriendFromParty(1) || iCanTakeFriendFromParty(2) || iCanTakeFriendFromParty(3) || iCanTakeFriendFromParty(4);
}

function iCanTakeFriendFromParty(n){  //detect exit head snake from Party
    return (!!$( '.snake.party' + n).length && $('.snake.head.party' + n).length !== 0 && partyFriends[n-1] > 0);
}

function iCanLeaveAnAlienInAnyParty(){
    return iCanLeaveAnAlienInParty(1) || iCanLeaveAnAlienInParty(2) || iCanLeaveAnAlienInParty(3) || iCanLeaveAnAlienInParty(4);
}

function iCanLeaveAnAlienInParty(n){  //detect exit friends and head snake from Party
    return !!$( '.snake.party' + n).length && !$('.snake.friends.party' + n).length && !$('.snake.head.party' + n).length && freePlaces[n-1] > 0;
}

function meetFreeAlien() {  //detect meeting with FreeAlien
    return $('.snake.freeAlien').length > 0 || $('.head.freeAlien').length > 0
}

</script>
</body>
</html>